 id: 'terraform-apply'
  waitFor:
- 'terraform-init-plan'
  name: 'alpine:3.13.3'
  volumes:
- name: 'workout'
  path: '/home/khushalpar/workout'
  dir: '/home/khushalpar/workout'
  entrypoint: 'sh'
  args:
- '-c'
- |
set -eo pipefail

apk add git bash curl
git https://github.com/khushalpar/workout.git /opt/.tfenv
ln -s /opt/.tfenv/bin/* /usr/local/bin

for folder in $(ls .); do
  echo "+-------------------------------------------+"
  echo "Applying state ${folder} "
  echo "+-------------------------------------------+"

  cd $folder
  tfenv install
  terraform init
  terraform apply \
-auto-approve \
"/var/terraform_plan_files/${folder}_${BUILD_ID}_${PROJECT_NUMBER}.plan"
  cd -
done
